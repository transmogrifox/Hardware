Version 4
SHEET 1 4228 7716
WIRE -880 2672 -960 2672
WIRE -448 2672 -528 2672
WIRE 96 2672 0 2672
WIRE 272 2672 176 2672
WIRE 480 2672 384 2672
WIRE 656 2672 560 2672
WIRE -960 2736 -960 2672
WIRE -528 2736 -528 2672
WIRE 0 2736 0 2672
WIRE 384 2736 384 2672
WIRE 1664 2784 1536 2784
WIRE 1536 2864 1536 2784
WIRE -960 2880 -960 2816
WIRE -528 2880 -528 2816
WIRE 0 2880 0 2816
WIRE 384 2880 384 2816
WIRE 1664 2912 1664 2784
WIRE 1536 2960 1536 2928
WIRE 1536 2960 1440 2960
WIRE 1536 2992 1536 2960
WIRE -880 3056 -960 3056
WIRE -48 3056 -128 3056
WIRE 1536 3104 1536 3056
WIRE -960 3120 -960 3056
WIRE -128 3120 -128 3056
WIRE 1536 3216 1536 3184
WIRE 1664 3216 1664 2992
WIRE 1664 3216 1536 3216
WIRE 1536 3248 1536 3216
WIRE -960 3264 -960 3200
WIRE -128 3264 -128 3200
WIRE -752 3792 -832 3792
WIRE -656 3792 -688 3792
WIRE -576 3792 -656 3792
WIRE -496 3792 -576 3792
WIRE -576 3872 -576 3792
WIRE -656 3904 -656 3792
WIRE -832 3952 -832 3792
WIRE -576 3968 -576 3952
WIRE -832 4096 -832 4032
WIRE -656 4096 -656 3968
WIRE -656 4096 -832 4096
WIRE -576 4096 -576 4048
WIRE -576 4096 -656 4096
WIRE -576 4112 -576 4096
WIRE -944 4336 -1024 4336
WIRE -256 4336 -336 4336
WIRE -1024 4400 -1024 4336
WIRE -336 4400 -336 4336
WIRE -1024 4544 -1024 4480
WIRE -336 4544 -336 4480
WIRE -960 4608 -1040 4608
WIRE -272 4608 -352 4608
WIRE -1040 4672 -1040 4608
WIRE -352 4672 -352 4608
WIRE -1040 4816 -1040 4752
WIRE -352 4816 -352 4752
WIRE -960 4912 -1040 4912
WIRE -272 4912 -352 4912
WIRE -1040 4976 -1040 4912
WIRE -352 4976 -352 4912
WIRE -1040 5120 -1040 5056
WIRE -352 5120 -352 5056
WIRE -976 5392 -1056 5392
WIRE -288 5392 -368 5392
WIRE -1056 5456 -1056 5392
WIRE -368 5456 -368 5392
WIRE -1056 5600 -1056 5536
WIRE -368 5600 -368 5536
WIRE -992 5664 -1072 5664
WIRE -304 5664 -384 5664
WIRE -1072 5728 -1072 5664
WIRE -384 5728 -384 5664
WIRE -1072 5872 -1072 5808
WIRE -384 5872 -384 5808
WIRE -992 5968 -1072 5968
WIRE -304 5968 -384 5968
WIRE -1072 6032 -1072 5968
WIRE -384 6032 -384 5968
WIRE -1072 6176 -1072 6112
WIRE -384 6176 -384 6112
WIRE 1376 6608 1296 6608
WIRE 1648 6608 1568 6608
WIRE -896 6640 -1008 6640
WIRE -896 6672 -896 6640
WIRE 1296 6672 1296 6608
WIRE 1568 6672 1568 6608
WIRE -896 6800 -896 6752
WIRE -896 6800 -1008 6800
WIRE 1296 6816 1296 6752
WIRE 1568 6816 1568 6752
WIRE -960 6896 -1008 6896
WIRE -960 6944 -960 6896
WIRE 1376 6944 1296 6944
WIRE 1616 6944 1536 6944
WIRE 1296 7008 1296 6944
WIRE 1536 7008 1536 6944
WIRE -960 7072 -960 7024
WIRE -960 7072 -1008 7072
WIRE 1296 7152 1296 7088
WIRE 1536 7152 1536 7088
WIRE -960 7264 -1008 7264
WIRE -960 7312 -960 7264
WIRE -960 7440 -960 7392
WIRE -960 7440 -1008 7440
FLAG -960 3264 0
FLAG -880 3056 iv0
FLAG -128 3264 0
FLAG -48 3056 iv1
FLAG -960 2880 0
FLAG -880 2672 mc
FLAG -528 2880 0
FLAG -448 2672 md
FLAG -1024 4544 0
FLAG -944 4336 acg
FLAG -336 4544 0
FLAG -256 4336 bcg
FLAG -576 4112 0
FLAG -496 3792 den
FLAG -1040 4816 0
FLAG -960 4608 ccg
FLAG -352 4816 0
FLAG -272 4608 dcg
FLAG -1040 5120 0
FLAG -960 4912 ecg
FLAG -352 5120 0
FLAG -272 4912 fcg
FLAG -1056 5600 0
FLAG -976 5392 adg
FLAG -368 5600 0
FLAG -288 5392 bdg
FLAG -1072 5872 0
FLAG -992 5664 cdg
FLAG -384 5872 0
FLAG -304 5664 ddg
FLAG -1072 6176 0
FLAG -992 5968 edg
FLAG -384 6176 0
FLAG -304 5968 fdg
FLAG -1008 6896 Vcg+
IOPIN -1008 6896 In
FLAG -1008 7072 Vcg-
IOPIN -1008 7072 In
FLAG -1008 7264 Vdg+
IOPIN -1008 7264 In
FLAG -1008 7440 Vdg-
IOPIN -1008 7440 In
FLAG -1008 6640 D+
IOPIN -1008 6640 In
FLAG -1008 6800 D-
IOPIN -1008 6800 In
FLAG 0 2880 0
FLAG 272 2672 D
FLAG 384 2880 0
FLAG 656 2672 Dp
FLAG 1536 3248 0
FLAG 1440 2960 D
FLAG 1296 7152 0
FLAG 1376 6944 Icharge
IOPIN 1376 6944 Out
FLAG 1536 7152 0
FLAG 1616 6944 Idischarge
IOPIN 1616 6944 Out
FLAG 1568 6816 0
FLAG 1648 6608 Ipeak
IOPIN 1648 6608 Out
FLAG 1296 6816 0
FLAG 1376 6608 Ivalley
IOPIN 1376 6608 Out
SYMBOL bv -960 3104 R0
SYMATTR InstName B9
SYMATTR Value V=V(iv1)+V(D)*V(mc)*Tsw  - V(Dp)*V(md)*Tsw
SYMBOL bv -128 3104 R0
SYMATTR InstName B10
SYMATTR Value V=delay(V(iv0), Tsw)
SYMBOL bv -960 2720 R0
SYMATTR InstName B11
SYMATTR Value V=V(Vcg+,Vcg-)/Lm
SYMBOL bv -528 2720 R0
SYMATTR InstName B12
SYMATTR Value V=V(Vdg+,Vdg-)/Lm
SYMBOL bv -1024 4384 R0
SYMATTR InstName B15
SYMATTR Value V=(1/(2*Tsw))*V(mc)
SYMBOL bv -336 4384 R0
SYMATTR InstName B16
SYMATTR Value V=-(1/(2*Tsw))*(V(mc) + 2*V(md))
SYMBOL bv -576 3952 R0
SYMATTR InstName B17
SYMATTR Value V=(V(mc)+V(md))**2
SYMBOL bv -1040 4656 R0
SYMATTR InstName B18
SYMATTR Value V=(1/(Tsw))*V(md)
SYMBOL bv -352 4656 R0
SYMATTR InstName B19
SYMATTR Value V=V(mc)*V(md)
SYMBOL bv -1040 4960 R0
SYMATTR InstName B20
SYMATTR Value V=V(md)*V(md)
SYMBOL bv -352 4960 R0
SYMATTR InstName B21
SYMATTR Value V=(Tsw/2)*V(mc)*V(md)*V(md)
SYMBOL bv -1056 5440 R0
SYMATTR InstName B22
SYMATTR Value V=-(1/(2*Tsw))*(2*V(mc)+V(md))
SYMBOL bv -368 5440 R0
SYMATTR InstName B23
SYMATTR Value V=(1/(2*Tsw))*V(md)
SYMBOL bv -1072 5712 R0
SYMATTR InstName B24
SYMATTR Value V=(1/(Tsw))*V(mc)
SYMBOL bv -384 5712 R0
SYMATTR InstName B25
SYMATTR Value V=V(mc)*V(mc)
SYMBOL bv -1072 6016 R0
SYMATTR InstName B26
SYMATTR Value V=V(mc)*V(md)
SYMBOL bv -384 6016 R0
SYMATTR InstName B27
SYMATTR Value V=(Tsw/2)*V(mc)*V(mc)*V(md)
SYMBOL bi -960 7392 R180
WINDOW 0 -80 83 Left 2
WINDOW 3 -1529 7 Left 2
SYMATTR InstName BIdg
SYMATTR Value I=(V(adg)*V(iv0)*V(iv0) + V(bdg)*V(iv1)*V(iv1) + V(cdg)*V(iv0)*V(iv1) + V(ddg)*V(iv0) + V(edg)*V(iv1) + V(fdg))/V(den)
SYMBOL bi -960 6944 R0
SYMATTR InstName BIcg
SYMATTR Value I=(V(acg)*V(iv0)*V(iv0) + V(bcg)*V(iv1)*V(iv1) + V(ccg)*V(iv0)*V(iv1) + V(dcg)*V(iv0) + V(ecg)*V(iv1) + V(fcg))/V(den)
SYMBOL res -592 3856 R0
SYMATTR InstName R12
SYMATTR Value 1
SYMBOL diode -752 3808 R270
WINDOW 0 32 32 VTop 2
WINDOW 3 0 32 VBottom 2
SYMATTR InstName D6
SYMATTR Value DI
SYMBOL bv -832 3936 R0
SYMATTR InstName B28
SYMATTR Value V=2u
SYMBOL cap -672 3904 R0
SYMATTR InstName C1
SYMATTR Value 100p
SYMBOL res -912 6656 R0
SYMATTR InstName R1
SYMATTR Value 10Meg
SYMBOL bv 0 2720 R0
SYMATTR InstName B1
SYMATTR Value V=V(D+,D-)
SYMBOL res 192 2656 R90
WINDOW 0 0 56 VBottom 2
WINDOW 3 32 56 VTop 2
SYMATTR InstName R2
SYMATTR Value 1K
SYMBOL bv 384 2720 R0
SYMATTR InstName B2
SYMATTR Value V=1-V(D)
SYMBOL res 576 2656 R90
WINDOW 0 0 56 VBottom 2
WINDOW 3 32 56 VTop 2
SYMATTR InstName R3
SYMATTR Value 1K
SYMBOL diode 1552 2928 R180
WINDOW 0 24 64 Left 2
WINDOW 3 24 0 Left 2
SYMATTR InstName D1
SYMATTR Value DI
SYMBOL diode 1552 3056 R180
WINDOW 0 24 64 Left 2
WINDOW 3 24 0 Left 2
SYMATTR InstName D2
SYMATTR Value DI
SYMBOL voltage 1664 2896 R0
SYMATTR InstName V1
SYMATTR Value {DMAX-1u}
SYMBOL voltage 1536 3088 M0
SYMATTR InstName V2
SYMATTR Value {1u}
SYMBOL bv 1296 6992 R0
SYMATTR InstName B3
SYMATTR Value V=I(BIcg)
SYMBOL bv 1536 6992 R0
SYMATTR InstName B4
SYMATTR Value V=I(BIdg)
SYMBOL bv 1568 6656 R0
SYMATTR InstName B5
SYMATTR Value V=V(iv0)+V(D)*Tsw*V(mc)
SYMBOL bv 1296 6656 R0
SYMATTR InstName B6
SYMATTR Value V=V(iv0)
TEXT -880 3080 Left 2 ;iv[n]
TEXT -1008 3400 Left 4 ;IIR FILTER VALLEY CURRENT TRANSFER FUNCTION
TEXT -1008 3440 Left 2 ;RELATES VALLEY CURRENTS TO DUTY CYCLE COMMAND SIGNAL
TEXT -48 3080 Left 2 ;iv[n-1]
TEXT 176 4576 Left 2 ;.param mc {Vcg/Lm}\n.param md {Vdg/Lm}\n.param dencom {(mc*mc + 2*mc*md + md*md)}\n.param acg {(1/(2*Tsw))*((mc)/dencom)}\n.param bcg {-(1/(2*Tsw))*((mc + 2*md)/dencom)}\n.param ccg {(1/(Tsw))*((md)/dencom)}\n.param dcg {(mc*md)/dencom}\n.param ecg {md*md/dencom}\n.param fcg  {(Tsw/2)*mc*md*md/dencom}
TEXT 848 4568 Left 2 ;INDUCTOR CURRENT CHARGING SLOPE\nINDUCTOR CURRENT DISCHARGING SLOPE\nCONVENIENT VARIABLE SUBSTITUTION FOR A DENOMINATOR TERM FOUND IN EVERY COEFFICIENT\nCOEFFICIENT: acg*iv[n]^2\nCOEFFICIENT: bcg*iv[n-1]^2\nCOEFFICIENT: ccg*iv[n]*iv[n-1]\nCOEFFICIENT: dcg*iv[n]\nCOEFFICIENT: ecg*iv[n-1]\nCONSTANT   :  fcg, APPEARS IN STEADY-STATE AVERAGE CURRENT COMPUTATION
TEXT 176 4880 Left 2 ;COMPUTED PARAMETERS -- SYSTEM VARIABLES AND COEFFICIENTS
TEXT 152 5632 Left 2 ;;.param mc {Vcg/Lm}\n;.param md {Vdg/Lm}\n;.param dencom {(mc*mc + 2*mc*md + md*md)}\n.param adg {-(1/(2*Tsw))*((2*mc + md)/dencom)}\n.param bdg {(1/(2*Tsw))*((md)/dencom)}\n.param cdg {(1/(Tsw))*((mc)/dencom)}\n.param ddg {(mc*mc)/dencom}\n.param edg {mc*md/dencom}\n.param fdg  {(Tsw/2)*md*mc*mc/dencom}
TEXT 824 5624 Left 2 ;INDUCTOR CURRENT CHARGING SLOPE\nINDUCTOR CURRENT DISCHARGING SLOPE\nCONVENIENT VARIABLE SUBSTITUTION FOR A DENOMINATOR TERM FOUND IN EVERY COEFFICIENT\nCOEFFICIENT: adg*iv[n]^2\nCOEFFICIENT: bdg*iv[n-1]^2\nCOEFFICIENT: cdg*iv[n]*iv[n-1]\nCOEFFICIENT: ddg*iv[n]\nCOEFFICIENT: edg*iv[n-1]\nCONSTANT   :  fdg, APPEARS IN STEADY-STATE AVERAGE CURRENT COMPUTATION
TEXT -824 7072 Left 2 ;V=V(acg)*V(iv0)*V(iv0) + V(bcg)*V(iv1)*V(iv1) + V(ccg)*V(iv0)*V(iv1) + V(dcg)*V(iv0) + V(ecg)*V(iv1) + V(fcg)
TEXT -840 7432 Left 2 ;V=V(adg)*V(iv0)*V(iv0) + V(bdg)*V(iv1)*V(iv1) + V(cdg)*V(iv0)*V(iv1) + V(ddg)*V(iv0) + V(edg)*V(iv1) + V(fdg)
TEXT -1056 5248 Left 3 ;CHARGE CYCLE NON-LTI FIR RESPONSE COEFFICIENTS
TEXT -1104 6256 Left 3 ;DISCHARGE CYCLE NON-LTI FIR RESPONSE COEFFICIENTS
TEXT 160 5920 Left 2 ;COMPUTED PARAMETERS -- SYSTEM VARIABLES AND COEFFICIENTS
TEXT -1024 4200 Left 3 ;SCALE FACTOR COMMON TO ALL FIR COEFFICIENTS
TEXT -544 6376 Left 4 ;FIR FILTER -- AVERAGE CURRENT TRANSFER FUNCTION
TEXT -544 6416 Left 2 ;RELATES AVERAGE CURRENTS TO VALLEY CURRENTS
TEXT 456 7072 Left 2 ;<--If "den" was not computed separately
TEXT 464 7432 Left 2 ;<--If "den" was not computed separately
TEXT -1104 7688 Left 4 ;INPUTS AND OUTPUTS
TEXT -912 7344 Left 3 ;DISCHARGE CYCLE CURRENT
TEXT -912 6984 Left 3 ;CHARGE CYCLE CURRENT
TEXT -848 6648 Left 3 ;DUTY CYCLE CONTROL INPUT
TEXT -1160 3528 Left 2 !.model DI D(Vfwd=1u Ron=1u)
TEXT 1528 3312 Left 2 ;DUTY LIMIT
TEXT 48 2944 Left 2 ;D (DUTY) AND D' (1-DUTY)
TEXT -888 2944 Left 2 ;IIR COEFFICIENTS
TEXT -1008 3344 Left 2 !.param Tsw {1/fsw}
LINE Normal -32 3424 -1008 3424 2
LINE Normal 1024 4896 176 4896 2
LINE Normal -208 5264 -1056 5264 2
LINE Normal -256 6272 -1104 6272 2
LINE Normal 1008 5936 160 5936 2
LINE Normal -224 4224 -1024 4224 2
LINE Normal 512 6400 -544 6400 2
LINE Normal -672 7712 -1104 7712 2
RECTANGLE Normal 1920 6464 -1200 3728 2
RECTANGLE Normal 1920 2608 -1184 3488 2
